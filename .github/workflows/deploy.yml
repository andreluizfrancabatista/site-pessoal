name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“ Display Deploy Info
      run: |
        echo "ğŸš€ Iniciando deploy para andrebatista.dev.br"
        echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "ğŸ“… Timestamp: $(date)"
    
    - name: ğŸ”‘ Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ§ª Test SSH Connection
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'âœ… SSH connection successful'"
    
    - name: ğŸ—‘ï¸ Clean Remote Directory
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          rm -rf /var/www/andre-batista/public/*
          echo 'ğŸ—‘ï¸ Remote directory cleaned'
        "
    
    - name: ğŸ“¤ Deploy Files to VPS
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='README.md' \
          --exclude='.gitignore' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/andre-batista/public/
        echo 'ğŸ“¤ Files transferred successfully'
    
    - name: ğŸ”§ Set Permissions
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          chown -R www-data:www-data /var/www/andre-batista/public/
          find /var/www/andre-batista/public/ -type d -exec chmod 755 {} \;
          find /var/www/andre-batista/public/ -type f -exec chmod 644 {} \;
          echo 'ğŸ”§ Permissions set correctly'
        "
    
    - name: âœ… Verify Deployment
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          echo 'ğŸ“Š Deployment Summary:'
          echo '   Files deployed to: /var/www/andre-batista/public/'
          echo '   Total files: \$(find /var/www/andre-batista/public/ -type f | wc -l)'
          echo '   Disk usage: \$(du -sh /var/www/andre-batista/public/ | cut -f1)'
          echo 'âœ… Deployment completed successfully!'
        "
    
    - name: ğŸŒ Display Access URL
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… DEPLOY CONCLUÃDO COM SUCESSO!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸŒ Acesse: https://andrebatista.dev.br"
        echo "ğŸ“… Deploy: $(date)"
        echo "ğŸ‘¤ Por: ${{ github.actor }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"